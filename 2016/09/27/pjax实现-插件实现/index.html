<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="tenbamboo"><meta name="description" content="上一篇基本介绍了HistoryAPI，这篇咱们可以同jquery插件来简单封装一个pjax来使用和体验下。"><meta name="keywords" content="pjax"><title>pjax实现-插件实现 · TenBamboo</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/09/27/pjax实现-插件实现/"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d4cfd0ae63812d27b7550688ba5a1c1f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script></head><body><div id="main"><header><a href="/." class="logo">TenBamboo</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Accueil</a></li><li class="nav-link"><a href="/archives" target="_self">Archives</a></li><li class="nav-link"><a href="/categories" target="_self">Catégories</a></li><li class="nav-link"><a href="/tags" target="_self">Tags</a></li><li class="nav-link"><a href="/about" target="_self">À propos</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">pjax实现-插件实现</h1><span class="post-time">2016年9月27日</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Sommaire</h3><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Jquery-插件脚手架"><span class="toc-text">Jquery 插件脚手架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pjax-参数定义"><span class="toc-text">Pjax 参数定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pjax-方法定义和实现DOM-Attr跳转"><span class="toc-text">Pjax 方法定义和实现DOM Attr跳转</span></a></li></ol></div><div class="post-content"><p><a href="https://tenbamboo.github.io/2016/09/21/pjax%E5%AE%9E%E7%8E%B0-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D/" target="_blank" rel="external">上一篇</a>基本介绍了History API，这篇咱们可以同jquery插件来简单封装一个pjax来使用和体验下。<br><a id="more"></a></p>
<h3 id="Jquery-插件脚手架"><a href="#Jquery-插件脚手架" class="headerlink" title="Jquery 插件脚手架"></a>Jquery 插件脚手架</h3><p>这块不用多说，网上有好多种插件开发的脚手架，直接上代码：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</div><div class="line">    <span class="comment">//配置参数</span></div><div class="line">    <span class="keyword">var</span> defaults = &#123;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">//public方法</span></div><div class="line">    <span class="keyword">var</span> methods = <span class="literal">null</span>;</div><div class="line">    <span class="comment">//private方法</span></div><div class="line">    <span class="keyword">var</span> _methods = <span class="literal">null</span>;</div><div class="line">    methods = &#123;</div><div class="line">    <span class="comment">//需要暴漏给外部的方法写在这里</span></div><div class="line">        init : <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">			defaults = $.extend(defaults, options);</div><div class="line">			_methods._initEvent();</div><div class="line">		&#125;,</div><div class="line">    &#125;;</div><div class="line">    _methods = &#123;</div><div class="line">    <span class="comment">//私有方法写在这里</span></div><div class="line">    &#125;;</div><div class="line">    $.pjax = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> method = <span class="built_in">arguments</span>[<span class="number">0</span>];</div><div class="line">		<span class="keyword">if</span> (methods[method]) &#123;</div><div class="line">			method = methods[method];</div><div class="line">			<span class="built_in">arguments</span> = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> (method) == <span class="string">'object'</span> || !method) &#123;</div><div class="line">			method = methods.init;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			$.error(<span class="string">'Method '</span> + method + <span class="string">' does not exist on jQuery.pjax'</span>);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">	&#125;;</div><div class="line">	</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure></p>
<p><br><br>基本的脚手架完成，下一步咱们直接说说我们需要的参数。</p>
<h3 id="Pjax-参数定义"><a href="#Pjax-参数定义" class="headerlink" title="Pjax 参数定义"></a>Pjax 参数定义</h3><p>参数的话，咱们可以方法 defaults 这个Object中。<br>下面讨论下咱们需要初始化pajx的参数：</p>
<p>1.mainContainer -&gt; 主容器,也就是需要把异步加载的HTML内容加载到哪个DOM中,这里一般都是一个DIV吧。</p>
<p>2.defaultLoad-&gt;默认初始化哪个页面，初始化成功的时候，咱们需要一个默认加载页面。还有就是如果在url找不到的时候这里也可以起到一个默认路由的作用，直接跳到默认的页。</p>
<p>3.suffix -&gt; 后缀，其实这个参数是方便书写，如果项目中的页面都是html的话，这个参数可以写成’html’ 然后在后续的操作跳转等操作的时候就不用写’xxx.html’了，直接写’xxx’即可</p>
<p>代码片段：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> defaults = &#123;</div><div class="line">		mainContainer:<span class="string">"mainContainer"</span>,</div><div class="line">		suffix:<span class="string">"html"</span>,</div><div class="line">		defaultLoad:<span class="string">"index"</span>,</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><br><br>后续还可以添加更丰富的功能，比如缓存机制，自定义跳转动画效果等功能，咱们现在就把基础的pjax现玩明白再说。</p>
<h3 id="Pjax-方法定义和实现DOM-Attr跳转"><a href="#Pjax-方法定义和实现DOM-Attr跳转" class="headerlink" title="Pjax 方法定义和实现DOM Attr跳转"></a>Pjax 方法定义和实现DOM Attr跳转</h3><p>关于页面的跳转其实就是主要的方法：<br>1.load -&gt; 跳转到指定的页面,还可以传各种参数（还可以允许是否可回退）。</p>
<p>2.back -&gt; 回退到之前的页面。</p>
<p>这里还需要DOM 属性来支持咱们的pjax，举个栗子：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span>&gt;</span>跳转<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这种代码需要直接支持pjax跳转怎么办？</p>
<p>这样写，然后看下后续的JS代码就知道了：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">pa-href</span>=<span class="string">"demo2"</span>  &gt;</span>跳转到demo2.html<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>下面代码是暴漏给外部的方法<br>代码片段：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">methods = &#123;</div><div class="line">        <span class="comment">//初始化调用</span></div><div class="line">		init : <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</div><div class="line">		    <span class="comment">//拼接参数</span></div><div class="line">			defaults = $.extend(defaults, options);</div><div class="line">			<span class="comment">//初始化事件</span></div><div class="line">			_methods._initEvent();</div><div class="line">		&#125;,</div><div class="line">        <span class="comment">//加载界面，</span></div><div class="line">        <span class="comment">//url -&gt;加载的url地址</span></div><div class="line">        <span class="comment">//param -&gt; 需要传到下个页面的参数,JSON格式</span></div><div class="line">        <span class="comment">//isNotBak -&gt;如果为true，则没有回退功能</span></div><div class="line">		load :<span class="function"><span class="keyword">function</span>(<span class="params">url,param,isNotBack</span>)</span>&#123;</div><div class="line">			_methods._load(url,param,!isNotBack);</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">//回退到上一个页面</span></div><div class="line">		back :<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">			_methods._back();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><br><br>下面介绍下私有的方法<br>代码片段：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">_methods =&#123;</div><div class="line">    <span class="comment">//初始化事件并调用基本事件</span></div><div class="line">	_initEvent:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	    <span class="comment">//实现DOM Attr方式调用</span></div><div class="line">		$(<span class="string">'body'</span>).delegate(<span class="string">'*[pa-href]'</span>, <span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">	        <span class="keyword">var</span> $<span class="keyword">this</span>=$(<span class="keyword">this</span>);</div><div class="line">	        <span class="keyword">var</span> href = $<span class="keyword">this</span>.attr(<span class="string">"pa-href"</span>);</div><div class="line">                <span class="keyword">if</span>($<span class="keyword">this</span>.attr(<span class="string">"pa-noBack"</span>)!=<span class="literal">undefined</span> &amp;&amp; $<span class="keyword">this</span>.attr(<span class="string">"pa-noBack"</span>) ==<span class="string">''</span>)&#123;</div><div class="line">		    	    _methods._load(href);</div><div class="line">		        &#125;<span class="keyword">else</span>&#123;</div><div class="line">		    	    _methods._load(href,&#123;&#125;,<span class="literal">true</span>);</div><div class="line">		        &#125;</div><div class="line">		&#125;);</div><div class="line">		    <span class="comment">//这里判断浏览器是否可用</span></div><div class="line">			<span class="keyword">if</span> (history.pushState) &#123;</div><div class="line">			    <span class="comment">//默认调用一次,来加载默认界面</span></div><div class="line">				_methods._changeHistory(<span class="literal">true</span>);</div><div class="line">				<span class="comment">//监听History改变</span></div><div class="line">				<span class="built_in">window</span>.addEventListener(<span class="string">"popstate"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</div><div class="line">					_methods._changeHistory(<span class="literal">false</span>);</div><div class="line">				&#125;);</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">//触发History改变事件调用</span></div><div class="line">		<span class="comment">//refresh -&gt; 若为true，则为首次刷新界面用，一般用于第一次调用时传true</span></div><div class="line">		_changeHistory:<span class="function"><span class="keyword">function</span>(<span class="params">refresh</span>)</span>&#123;</div><div class="line">		    <span class="comment">//判断paHref参数如果在url有值则代表需要跳转到指定页面.</span></div><div class="line">			<span class="keyword">var</span> href=_methods._getParam(<span class="string">'paHref'</span>);</div><div class="line">			<span class="keyword">if</span>(href)&#123;</div><div class="line">				_methods._load(href,&#123;&#125;,refresh);</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				_methods._load(defaults.defaultLoad);</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">//获取URL中的某些参数</span></div><div class="line">		_getParam:<span class="function"><span class="keyword">function</span>(<span class="params">name</span>)</span>&#123;</div><div class="line">			<span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</div><div class="line">			<span class="keyword">var</span> r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</div><div class="line">			<span class="keyword">if</span> (r != <span class="literal">null</span>)</div><div class="line">				<span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</div><div class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">//核心方法,加载指定URL内容到主容器中</span></div><div class="line">	    <span class="comment">//方法就不介绍了,上面已经介绍了</span></div><div class="line">		_load:<span class="function"><span class="keyword">function</span>(<span class="params">url,param,isBack</span>)</span>&#123;</div><div class="line">			</div><div class="line">			<span class="keyword">var</span> main=$(<span class="string">"#"</span>+defaults.mainContainer);</div><div class="line">			<span class="comment">//滚动到顶部</span></div><div class="line">			<span class="built_in">window</span>.scrollTo(<span class="number">0</span>,<span class="number">0</span>);</div><div class="line">			<span class="comment">//动画效果 </span></div><div class="line">			<span class="comment">//动画离开</span></div><div class="line">			main.fadeOut(<span class="number">200</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">			    <span class="comment">//加载URL的内容到容器中</span></div><div class="line">				main.load(url+<span class="string">"."</span>+defaults.suffix,&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">html</span>)</span>&#123;</div><div class="line">					<span class="comment">//动画进入</span></div><div class="line">					main.fadeIn(<span class="number">200</span>);</div><div class="line">					<span class="comment">//处理title</span></div><div class="line">					<span class="keyword">var</span> matches = html.match(<span class="regexp">/&lt;title&gt;(.*?)&lt;\/title&gt;/</span>);</div><div class="line">					<span class="keyword">if</span> (matches) &#123;</div><div class="line">						title = matches[<span class="number">1</span>];</div><div class="line">						<span class="built_in">document</span>.title = title;</div><div class="line">					&#125;</div><div class="line">				&#125;)</div><div class="line">			&#125;);</div><div class="line">			</div><div class="line">			<span class="comment">//获取URL的URL部分</span></div><div class="line">			<span class="keyword">var</span> href=location.href.split(<span class="string">"?"</span>)[<span class="number">0</span>];</div><div class="line">			<span class="comment">//判断是否可以回退</span></div><div class="line">			<span class="keyword">if</span>(isBack)&#123;</div><div class="line">			    <span class="comment">//把需要跳转的URL写入URL中</span></div><div class="line">				href+=<span class="string">"?paHref="</span> + url;</div><div class="line">				<span class="comment">//拼接请求参数</span></div><div class="line">				<span class="keyword">if</span>(param &amp;&amp; !$.isEmptyObject(param))&#123;</div><div class="line">					href+=<span class="string">"&amp;"</span>+$.param(param);</div><div class="line">				&#125;<span class="keyword">else</span>&#123;</div><div class="line">					<span class="keyword">var</span> p=<span class="built_in">window</span>.location.search;</div><div class="line">					<span class="keyword">if</span>(p.indexOf(<span class="string">'&amp;'</span>)!= <span class="number">-1</span>)&#123;</div><div class="line">						href+=p.substring(p.indexOf(<span class="string">'&amp;'</span>))</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">				&#125;</div><div class="line">				<span class="comment">//直接push到History,并记录</span></div><div class="line">				history.pushState(&#123;isBack:isBack&#125;, <span class="built_in">document</span>.title,  href);</div><div class="line">			&#125;</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">//回退</span></div><div class="line">		_back:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">			history.back();</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p><a href="https://tenbamboo.github.io/2016/09/27/pjax%E5%AE%9E%E7%8E%B0-%E6%8F%92%E4%BB%B6%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8/" target="_blank" rel="external">下一篇介绍怎么来实际使用插件来工作。</a></p>
<p><a href="https://github.com/tenbamboo/jquery-pjax" target="_blank" rel="external">git项目地址</a></p>
<p>用右眼看世界</p>
<p><img src="http://tenbamboo.qiniudn.com/2016-09-21-04.jpg" alt=""></p>
</div></article><div class="tags"><a href="/tags/pjax/">pjax</a></div><div class="paginator"><a href="/2016/09/27/pjax实现-插件实际使用/" class="prev"><i class="iconfont icon-left"></i><span> Précédent</span></a><a href="/2016/09/21/pjax实现-基本介绍/" class="next"><span>Suivant</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://yoursite.com/2016/09/27/pjax实现-插件实现/index.html" data-title="pjax实现-插件实现" data-url="http://yoursite.com/2016/09/27/pjax实现-插件实现/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "tembamboo" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">tenbamboo</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>